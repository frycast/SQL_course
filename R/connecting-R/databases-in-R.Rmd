---
title: "Connecting to SQL databases with R"
author: Daniel Fryer
date: November 11, 2021
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

Setting up and connecting to SQL servers can get tricky, with all the authentication methods and security measures, hardware differences, etc.
 
This is a general guide, for both MySQL and T-SQL. We will learn to:

1. Create and connect to a local server.
2. Connect to a remote database.

If you're here to get connected to a remote MySQL database, 
then I've prepared an R script to get you started.
[Click here to access the MySQL connection script](./remote-MySQL.R).

## 1. Create and connect to a local server

Before connecting to a local server in R, you should create the server, install a popular SQL code editor, and insert some practice data. For this, I've created the two guides linked below. Please go through one of them before continuing.

* [For T-SQL installation (easier on windows) click here](https://github.com/frycast/SQL_course/tree/master/create-database/T-SQL) 

* [For MySQL installation (easier on macOS) click here](https://github.com/frycast/SQL_course/tree/master/create-database/MySQL)

You'll also need to have R and RStudio set up on your computer. Here is a good tutorial for that:

* [Click here for the ModernDive R installation tutorial](https://moderndive.netlify.app/1-getting-started.html#installing)

Once the SQL server and R are both set up, sometimes the rest will go really smoothly, but sometimes it won't. If you run into trouble, you might need to use a search engine and/or browse through forums to find some suggestions. If you're a student taking one of my SQL courses, you can contact me any time for help!

#### Connect to a local MySQL server

First, run the code below to install the required R package:

```{r, eval=FALSE}
install.packages("RMySQL")
library(RMySQL)
```

Then, the following R code should get you connected. Note that the database named 'Sandpit' was created within the above MySQL installation guide. 

```{r, eval=FALSE}
con <- DBI::dbConnect(
  RMySQL::MySQL(), 
  dbname = "Sandpit", 
  host = "localhost")
```

If the above causes an error that mentions `caching_sha2_password could not be loaded`, then connect to localhost using MySQL Workbench (or Sequel Ace, or whichever SQL editor you have installed), and run the SQL code below. *Warning:* this creates a very insecure user account, so you should never do this on a server that is open to the public and contains sensitive or private data. I'm assuming you're setting up this database on your home computer just to experiment with fake data.

```{SQL, eval=FALSE}
CREATE USER 'R'@'localhost' IDENTIFIED WITH mysql_native_password BY 'password';
GRANT ALL PRIVILEGES ON *.* TO 'R'@'localhost' WITH GRANT OPTION;
```

Once you've run the above SQL code, you should be able to connect with:

```{r, eval=FALSE}
con <- DBI::dbConnect(
  RMySQL::MySQL(), 
  dbname = "Sandpit", 
  host = "localhost",
  user = "R",
  password = "password")
```

Once the code is executed without error, it means the connection is established. To test it, you can check that the following returns a list of table names.

```{r, eval=FALSE}
DBI::dbListTables(con)
```

Guidelines for using the connection are given in the R chapter of the course notes. Once you're done using the connection, remember to disconnect:

```{r, eval=FALSE}
DBI::dbDisconnect(con)
```

#### Connect to a local T-SQL server

First, run the code below to install the required R package:

```{r, eval=FALSE}
install.packages(c("odbc","DBI"))
library(odbc)
library(DBI)
```

Then, the following R code should get you connected. Note that the database named 'Sandpit' was created within the above T-SQL installation guide.

```{r, eval=FALSE}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver = "ODBC Driver 17 for SQL Server",
                      Server = "localhost",
                      Database = "Sandpit",
                      Trusted_Connection = "yes")
```

If the above fails, there may be alternative drivers that can be used in place of `ODBC Driver 17 for SQL Server`. However, the other parameters will change too. A common alternative is:

```{r, eval=FALSE}
con <- DBI::dbConnect(odbc::odbc(),
                      Driver = "SQL Server",
                      Server = "localhost",
                      Database = "master",
                      Trusted_Connection = "True")
```

Small details make a difference. For example, the `Trusted_Connection` parameter in the second example is set to `"True"`, while in the first example it is `"yes"`. A large collection of alternative connection strings can be found on [connectionstrings.com](https://www.connectionstrings.com/sql-server/).

Once the code is executed without error, it means the connection is established. To test it, you can check that the following returns a list of table names.

```{r, eval=FALSE}
DBI::dbListTables(con)
```

Guidelines for using the connection are given in the R chapter of the course notes. Once you're done using the connection, remember to disconnect:

```{r, eval=FALSE}
DBI::dbDisconnect(con)
```

## 2. Connect to a remote server

Connecting to a remote database means you can avoid the hassle of installing a local MySQL or T-SQL server. You will need some connection details specific to the database you plan to connect to. The types of details you need depend on whether you're connecting to a MySQL or T-SQL server.

#### Connect to a remote MySQL server

First, run the code below to install the required R package:

```{r, eval=FALSE}
install.packages("RMySQL")
library(RMySQL)
```

Then, use the following to connect:

```{r, eval=FALSE}
con <- DBI::dbConnect(RMySQL::MySQL(), 
                 host = "write_host_address_here", 
                 port = 0000, # Replace this number with the actual port number 
                 dbname = "write_database_name_here", 
                 user =  "write_user_name_here", 
                 password = "write_your_password_here")
```

Once the code is executed without error, it means the connection is established. To test it, you can check that the following returns a list of table names.

```{r, eval=FALSE}
DBI::dbListTables(con)
```

Guidelines for using the connection are given in the R chapter of the course notes. Once you're done using the connection, remember to disconnect:

```{r, eval=FALSE}
DBI::dbDisconnect(con)
```

#### Connect to a remote T-SQL server

First, run the code below to install the required R package:

```{r, eval=FALSE}
install.packages(c("odbc","DBI"))
library(odbc)
library(DBI)
```

Then, use the following to connect:

```{r, eval=FALSE}
con <- odbc::dbConnect(odbc::odbc(),
                      Driver = "SQL Server",
                      Server = "write_server_address_here",
                      Database = "write_database_name_here",
                      UID = "write_user_name_here",
                      PWD = "write_your_password_here")
```

Once the code is executed without error, it means the connection is established. To test it, you can check that the following returns a list of table names.

```{r, eval=FALSE}
DBI::dbListTables(con)
```

Guidelines for using the connection are given in the R chapter of the course notes. Once you're done using the connection, remember to disconnect:

```{r, eval=FALSE}
DBI::dbDisconnect(con)
```